# 日向坂ポータル 動画一括登録機能 設計書

## 1. 概要 (Overview)
日向坂46のMV、個人PV、ライブ映像などを管理するために、外部メディア（主にYouTube）を一括で登録・紐付けする機能を実装する。
本機能は既存の `com_media_assets`（メディア素材）と `hn_media_metadata`（日向坂コンテキスト）への同時登録を行う。

## 2. 要件定義 (Requirements)

- **対象ユーザー**: 管理者権限（role='admin'）を持つユーザーのみ。
- **入力方式**: テキストエリアへのCSV（またはTSV）貼り付け。
- **処理フロー**:
    1.  **入力**: URL、タイトル、公開日、カテゴリ等をテキストエリアに入力。
    2.  **解析 (Preview)**: URLを解析し、サムネイル取得・重複チェックを行った結果をテーブル表示（非同期）。
    3.  **実行 (Execute)**: 問題のないデータのみを一括でDBへ保存。

## 3. データフォーマット (Input Format)
テキストエリアに入力するデータは以下のタブ区切り（またはカンマ区切り）とする。

```text
[URL] <tab> [Title] <tab> [ReleaseDate(Optional)] <tab> [Category(Optional)]
```


- **URL**: YouTubeの動画URL（必須）。
    
- **Title**: 動画タイトル（必須）。
    
- **ReleaseDate**: `YYYY-MM-DD` 形式（任意）。空欄の場合は `NULL`。
    
- **Category**: `MV`, `Live`, `Variety`, `SoloPV` 等（任意）。
    
    - CSVでの指定がない場合、画面上の「デフォルトカテゴリ」プルダウンの値を使用する。
        

## 4. 画面設計 (UI Design)

### 4.1. 画面構成

- **ファイルパス**: `private/apps/Hinata/Views/media_import.php`
    
- **URL**: `/hinata/media_import.php`
    

#### A. 入力セクション

- **Default Category Select**: CSVでカテゴリ未指定時の値を設定（例: MV）。
    
- **Bulk Textarea**: CSVデータを貼り付ける領域。
    
- **Preview Button**: 非同期で解析APIを叩く。
    

#### B. プレビューセクション (初期状態は非表示)

- **Status Summary**: 「登録予定: X件 / エラー: Y件 / 済: Z件」
    
- **Table**:
    
    - **Thumb**: YouTubeサムネイル画像を表示 (`https://img.youtube.com/vi/[VIDEO_ID]/default.jpg`)。
        
    - **Status**:
        
        - `New` (青): 新規登録。
            
        - `Linked` (緑): 素材はDBにあるが、日向坂メタデータのみ新規作成。
            
        - `Registered` (灰): 既に日向坂メタデータとして登録済み（スキップ）。
            
        - `Error` (赤): URL不正など。
            
    - **Title**: 入力されたタイトル。
        
    - **Category**: 適用されるカテゴリ。
        
    - **Action**: 「除外」ボタン（行を削除）。
        

#### C. アクション

- **Execute Button**: 有効なデータのみをJSON化して保存APIへ送信。
    

## 5. バックエンド設計 (Backend Architecture)

### 5.1. Controller / Logic

新しく `App\Hinata\Controller\MediaController` を作成する。

#### メソッド構成

1. **import()**: インポート画面の表示（GET）。
    
2. **preview()**: 入力テキストを受け取り、解析結果をJSONで返す（POST / API）。
    
    - `Core\MediaAssetModel::parseUrl()` を使用して `media_key` を抽出。
        
    - `com_media_assets` および `hn_media_metadata` を検索し、登録状況（Status）を判定する。
        
3. **bulkSave()**: 確定データを受け取り、トランザクション内で保存する（POST / API）。
    

### 5.2. データベース操作 (Models)

#### 使用するモデル

- `Core\MediaAssetModel` (既存)
    

#### 保存ロジック (MediaAssetModelへの拡張または利用)

ループ処理内で以下を実行する。
1. **Asset登録 (`com_media_assets`)**
	 - `media_key` (動画ID) で検索。        
    - 存在しなければ `INSERT`。        
    - 存在すれば `id` を取得。        
2. **Metadata登録 (`hn_media_metadata`)**
    - 取得した `asset_id` と `category` で検索。
    - 存在しなければ `INSERT`（`asset_id`, `category`, `release_date`）。
    - 存在すればスキップ。

3. ファイル構成案 (File Structure)
```
private/
  apps/
    Hinata/
      Controller/
        MediaController.php  (New: インポート・保存ロジック)
      Views/
        media_import.php     (New: UI)
www/
  hinata/
    media_import.php         (New: エントリポイント)
    api/
      preview_media.php      (New: プレビュー用API)
      save_media_bulk.php    (New: 保存用API)   
```
## 7. 実装ステップ (Implementation Steps)

1. **View作成**: `media_import.php` のUI（Tailwind CSS）を作成。
    
2. **Preview API実装**:
    
    - CSVパース処理。
        
    - `MediaAssetModel` を利用したURL解析とDB照会ロジック。
        
3. **JavaScript実装**:
    
    - `preview_media.php` へのPOSTと、結果テーブルの動的レンダリング。
        
    - サムネイル画像の表示。
        
4. **Save API実装**:
    
    - `save_media_bulk.php` へのPOST。
    - DBトランザクション処理。
        
5. **結合テスト**:
    
    - 新規動画の登録。        
    - 既存アセット（別カテゴリ）の紐付け登録。        
    - 完全重複データのスキップ確認。
        

## 8. 参考：既存クラス定義 (Reference)

### Core\MediaAssetModel

```
class MediaAssetModel extends BaseModel {
    // ...
    public function parseUrl(string $url): ?array; // returns ['platform', 'media_key', ...]
    public function findOrCreateAsset(...): ?int;
    public function findOrCreateMetadata(...): ?int;
}
```

### DB Schema (Target)
```
-- 素材マスタ
com_media_assets (id, platform, media_key, title, thumbnail_url, ...)
-- 日向坂メタデータ
hn_media_metadata (id, asset_id, category, release_date)
```