# 日向坂ポータル システム構成書

**最終更新**: 2026-02-13  
**バージョン**: 1.0

---

## 目次

1. [概要](#概要)
2. [システムアーキテクチャ](#システムアーキテクチャ)
3. [データベース設計](#データベース設計)
4. [ディレクトリ構造](#ディレクトリ構造)
5. [実装済み機能](#実装済み機能)
6. [データフロー](#データフロー)
7. [API仕様](#api仕様)
8. [使用方法](#使用方法)
9. [今後の拡張予定](#今後の拡張予定)

---

## 概要

### 目的
日向坂46に関する情報（メンバー、イベント、楽曲、動画等）を一元管理し、効率的に閲覧・編集できるポータルサイト。

### 主要機能
- **メンバー管理**: プロフィール、個人PV、推しメンバー登録
- **イベント管理**: ライブ、ミーグリ、リリース日程
- **リリース・楽曲管理**: シングル・アルバム、収録曲、フォーメーション
- **動画一括登録**: YouTube動画の一括インポート
- **ミーグリネタ帳**: トークネタの記録・管理

### 技術スタック
- **Backend**: PHP 8.2 (独自MVC)
- **Database**: MariaDB/MySQL
- **Frontend**: Tailwind CSS + Vanilla JavaScript
- **API**: REST API形式

---

## システムアーキテクチャ

### 設計思想

#### 1. データ正規化と柔軟性の両立
```
com_media_assets（プラットフォーム非依存の動画素材）
    ↓ 1:1
hn_media_metadata（日向坂コンテキスト：統一窓口）
    ↓ 1:N（カテゴリに応じて分岐）
    ├─ hn_songs（楽曲MV）
    ├─ hn_event_movies（イベント動画）
    └─ hn_media_members（個人PV）
```

#### 2. 共通基盤の活用
- `Core\BaseModel`: 全モデルの基底クラス
- `Core\MediaAssetModel`: メディア素材の統一管理
- `Core\Database`: PDO接続管理
- `Core\Auth`: 認証・セッション管理

#### 3. ユーザーデータ隔離
- `BaseModel::$isUserIsolated = true`: ユーザー単位のデータ分離
- `BaseModel::$isUserIsolated = false`: 全ユーザー共通データ

---

## データベース設計

### ER図（概念）

```
hn_releases (リリース)
    ↓ 1:N
hn_songs (楽曲)
    ↓ 1:1 or NULL
hn_media_metadata (日向坂メタデータ)
    ↓ 1:1
com_media_assets (動画素材)

hn_songs
    ↓ 1:N
hn_song_members (楽曲参加メンバー)
    ↓ N:1
hn_members (メンバー)
```

---

### テーブル定義

#### **com_media_assets**（メディア素材マスタ）
YouTube、TikTok、Instagram等のメディア素材を統一管理。

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | bigint(20) UNSIGNED | 主キー |
| platform | ENUM | youtube, tiktok, instagram |
| media_key | varchar(100) | 動画ID、ショートコード |
| sub_key | varchar(100) | TikTokのユーザー名等 |
| title | varchar(255) | タイトル |
| thumbnail_url | varchar(255) | サムネイルURL |
| created_at | datetime | 作成日時 |

**UNIQUE KEY**: `platform`, `media_key`

---

#### **hn_media_metadata**（日向坂メタデータ）
日向坂関連動画の統一エントリーポイント。

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | bigint(20) UNSIGNED | 主キー |
| asset_id | bigint(20) UNSIGNED | 動画素材ID（com_media_assets.id） |
| category | varchar(50) | MV, Live, Variety, Event, SoloPV等 |
| release_date | date | 公開日（オプション） |
| created_at | datetime | 作成日時 |

**UNIQUE KEY**: `asset_id`（1動画に1メタデータ）  
**外部キー**: `asset_id` → `com_media_assets.id`

---

#### **hn_releases**（リリースマスタ）
シングル・アルバム情報。

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | int(11) | 主キー |
| release_type | ENUM | single, album, digital, ep, best |
| release_number | varchar(20) | 1st, 2nd, ベスト等 |
| title | varchar(255) | リリースタイトル |
| title_kana | varchar(255) | よみがな |
| release_date | date | 発売日 |
| jacket_image_url | varchar(255) | ジャケット画像URL |
| description | text | 説明・備考 |
| created_at | datetime | 作成日時 |

**例**:
- 1stシングル「キュン」（2019-03-27）
- 2ndシングル「ドレミソラシド」（2019-07-17）

---

#### **hn_songs**（楽曲マスタ）
リリース収録曲の詳細情報。

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | bigint(20) UNSIGNED | 主キー |
| release_id | int(11) | リリースID |
| media_meta_id | bigint(20) UNSIGNED | メディアメタデータID（MVがある場合） |
| title | varchar(255) | 楽曲タイトル |
| title_kana | varchar(255) | よみがな |
| track_type | ENUM | title, coupling, album_only, bonus, kisei, unit, solo, other |
| track_number | int(11) | トラック番号 |
| lyricist | varchar(255) | 作詞 |
| composer | varchar(255) | 作曲 |
| duration | int(11) | 再生時間（秒） |
| memo | text | 備考 |
| created_at | datetime | 作成日時 |

**UNIQUE KEY**: `media_meta_id`（1MVに1楽曲）  
**外部キー**: 
- `release_id` → `hn_releases.id`
- `media_meta_id` → `hn_media_metadata.id`

**設計ポイント**:
- センター情報は削除（`hn_song_members` で管理）
- MVが存在しない楽曲は `media_meta_id = NULL`

---

#### **hn_song_members**（楽曲参加メンバー）
楽曲ごとの参加メンバーとフォーメーション情報。

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | bigint(20) UNSIGNED | 主キー |
| song_id | bigint(20) UNSIGNED | 楽曲ID |
| member_id | int(11) | メンバーID |
| role | ENUM | center, member, under, other |
| row_number | tinyint | 1:フロント, 2:2列目, 3:3列目, NULL:不明 |
| position | int(11) | 列内の位置（中央0、左負、右正） |
| is_featured | tinyint(1) | 主役級フラグ（センター・ソロパート多め） |
| part_description | varchar(255) | パート説明 |

**UNIQUE KEY**: `song_id`, `member_id`  
**外部キー**:
- `song_id` → `hn_songs.id`
- `member_id` → `hn_members.id`

**フォーメーション構造**:
```
  ○  ○  ○  ○  ○  ○  ○   ← 3列目（後列）row_number=3
    ○   ○   ○   ○   ○   ← 2列目 row_number=2
       ○  ●  ●  ○       ← フロント（1列目）row_number=1
                         ● = センター（role='center'）
       観客側（手前）
```

**データ例（ダブルセンター）**:
```sql
-- フロント（1列目）: 4人
(song_id=1, member_id=2, role='member', row_number=1, position=-2)  -- 左端
(song_id=1, member_id=5, role='center', row_number=1, position=-1)  -- センター左
(song_id=1, member_id=10, role='center', row_number=1, position=1)  -- センター右
(song_id=1, member_id=3, role='member', row_number=1, position=2)   -- 右端
```

---

#### **hn_members**（メンバーマスタ）
メンバープロフィール情報。

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | int(11) | 主キー |
| name | varchar(100) | 名前 |
| kana | varchar(100) | よみがな |
| generation | int(11) | 期生 |
| birth_date | date | 生年月日 |
| blood_type | varchar(10) | 血液型 |
| height | decimal(4,1) | 身長 |
| birth_place | varchar(100) | 出身地 |
| color_id1 | int(11) | サイリウムカラー1 |
| color_id2 | int(11) | サイリウムカラー2 |
| is_active | tinyint(1) | 現役フラグ |
| image_url | varchar(255) | 画像URL |
| blog_url | varchar(255) | ブログURL |
| insta_url | varchar(255) | InstagramURL |
| twitter_url | varchar(255) | TwitterURL |
| member_info | text | メンバー情報 |

---

#### **hn_media_members**（個人PV紐付け）
メンバーと個人PVの多対多紐付け。

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | bigint(20) UNSIGNED | 主キー |
| media_meta_id | bigint(20) UNSIGNED | メディアメタデータID |
| member_id | int(11) | メンバーID |

**UNIQUE KEY**: `media_meta_id`, `member_id`

---

#### **hn_events**（イベントマスタ）
ライブ、ミーグリ、発売日等のイベント情報。

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | int(11) | 主キー |
| event_name | varchar(255) | イベント名 |
| event_date | date | 開催日 |
| category | int(11) | 1:Live, 2:MG, 3:RMG, 4:Rel, 5:Med, 6:SP, 99:Other |
| event_place | varchar(255) | 開催場所 |
| event_info | text | イベント情報 |
| event_url | varchar(255) | URL |

---

#### **hn_neta**（トークネタ帳）
ミーグリ用のトークネタ記録。

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | int(11) | 主キー |
| user_id | int(11) | ユーザーID |
| member_id | int(11) | メンバーID |
| content | text | ネタ内容 |
| memo | text | メモ |
| status | ENUM | stock, done, delete |

---

## ディレクトリ構造

```
/home/USER/
├─ private/                         # 非公開領域
│   ├─ lib/                         # Core名前空間（共通基盤）
│   │   ├─ Database.php             # PDO接続管理
│   │   ├─ Auth.php                 # 認証・セッション
│   │   ├─ BaseModel.php            # 全モデルの基底クラス
│   │   ├─ MediaAssetModel.php      # メディア素材管理
│   │   ├─ Logger.php               # ログ出力
│   │   ├─ Validator.php            # バリデーション
│   │   └─ SessionManager.php       # セッション管理
│   │
│   ├─ apps/                        # アプリケーション層
│   │   └─ Hinata/                  # 日向坂アプリ
│   │       ├─ Controller/
│   │       │   ├─ HinataController.php       # ポータル画面
│   │       │   ├─ MemberController.php       # メンバー管理
│   │       │   ├─ EventController.php        # イベント管理
│   │       │   ├─ TalkController.php         # ネタ帳管理
│   │       │   ├─ MediaController.php        # 動画一括登録
│   │       │   └─ ReleaseController.php      # リリース管理
│   │       │
│   │       ├─ Model/
│   │       │   ├─ MemberModel.php            # メンバーモデル
│   │       │   ├─ EventModel.php             # イベントモデル
│   │       │   ├─ NetaModel.php              # ネタ帳モデル
│   │       │   ├─ ReleaseModel.php           # リリースモデル
│   │       │   ├─ SongModel.php              # 楽曲モデル
│   │       │   └─ SongMemberModel.php        # 楽曲参加メンバーモデル
│   │       │
│   │       └─ Views/
│   │           ├─ portal.php                 # ポータル画面
│   │           ├─ members.php                # メンバー一覧
│   │           ├─ member_admin.php           # メンバー管理
│   │           ├─ event_index.php            # イベント一覧
│   │           ├─ event_admin.php            # イベント管理
│   │           ├─ talk_index.php             # ネタ帳
│   │           ├─ media_import.php           # 動画一括登録
│   │           └─ release_admin.php          # リリース管理
│   │
│   ├─ components/                  # 共通コンポーネント
│   │   └─ sidebar.php              # サイドバー
│   │
│   ├─ migrations/                  # DBマイグレーションSQL
│   │   ├─ db_migration_releases.sql        # リリース管理テーブル作成
│   │   └─ db_migration_releases_update.sql # フォーメーション機能追加
│   │
│   ├─ vendor/                      # Composer依存パッケージ
│   ├─ composer.json                # オートロード設定
│   └─ .env                         # 環境変数（DB接続情報等）
│
└─ www/                             # Document Root（公開領域）
    ├─ assets/                      # 共通フロント
    │   ├─ css/
    │   ├─ js/
    │   └─ vendor/
    │
    ├─ hinata/                      # 日向坂エントリポイント
    │   ├─ index.php                # ポータル
    │   ├─ members.php              # メンバー一覧
    │   ├─ member_admin.php         # メンバー管理
    │   ├─ events.php               # イベント一覧
    │   ├─ event_admin.php          # イベント管理
    │   ├─ talk.php                 # ネタ帳
    │   ├─ media_import.php         # 動画一括登録
    │   ├─ media_list.php           # 動画一覧
    │   ├─ media_member_admin.php   # 動画・メンバー紐付け管理
    │   ├─ release_admin.php        # リリース管理
    │   │
    │   └─ api/                     # REST API
    │       ├─ save_member.php
    │       ├─ save_event.php
    │       ├─ save_neta.php
    │       ├─ preview_media.php    # 動画プレビュー
    │       ├─ save_media_bulk.php  # 動画一括保存
    │       ├─ load_more_media.php  # 動画一覧追加読み込み
    │       ├─ list_media_for_link.php  # 紐付け用動画一覧
    │       ├─ get_media_members.php    # 動画に紐づくメンバー取得
    │       ├─ save_media_members.php   # 動画・メンバー紐付け保存
    │       ├─ save_release.php     # リリース保存
    │       └─ delete_release.php   # リリース削除
    │
    └─ index.php                    # 総合ポータル
```

---

## 実装済み機能

### 1. メンバー管理
- **メンバー一覧表示**: 現役・卒業メンバー、サイリウムカラー表示
- **メンバー詳細**: プロフィール、個人PV、推しレベル設定
- **メンバー管理画面**（管理者専用）: プロフィール編集、画像アップロード、個人PV紐付け

### 2. イベント管理
- **イベント一覧**: カレンダー形式、参戦状況管理
- **イベント管理画面**（管理者専用）: イベント登録・編集、出演者選択、関連動画紐付け

### 3. ミーグリネタ帳
- **ネタ記録**: メンバー別、ストック・完了・削除管理
- **絞り込み**: ステータス、メンバー別フィルタ

### 4. 動画一括登録（NEW）
- **CSV/TSV入力**: URL、タイトル、シングル番号、公開日、カテゴリ
- **プレビュー機能**: 
  - YouTubeサムネイル自動取得
  - 重複チェック（New/Linked/Registered/Error）
  - 除外機能
  - シングル番号からの自動リリース紐付け
  - 楽曲情報登録（MV専用）

### 5. 動画・メンバー紐付け管理（NEW・管理者専用）
- **動画選択**: 検索・カテゴリフィルタで動画一覧表示
- **紐づけ編集**: 選択した動画に出演メンバーを追加・削除
- **保存**: hn_media_members テーブルに反映

### 6. 動画一覧
- **閲覧機能**: すべてのユーザーが閲覧可能
- **表示形式**: ブロック形式 / 一覧形式の切り替え
- **フィルタリング**: カテゴリ別絞り込み、並び順変更（新しい順/古い順/タイトル順）
- **無限スクロール**: 25件ずつ自動読み込み
- **対応プラットフォーム**: YouTube、TikTok、Instagram（拡張可能）
- **一括保存**: トランザクション処理、エラーハンドリング

### 5. リリース・楽曲管理（NEW）
- **リリース登録**: シングル・アルバム情報管理
- **楽曲管理**: 収録曲、トラック番号、作詞作曲者
- **フォーメーション管理**: 
  - 列別配置（フロント、2列目、3列目）
  - センター管理（ダブルセンター対応）
  - 位置情報（中央からの相対位置）

---

## データフロー

### 動画一括登録のフロー

```
1. ユーザー入力（CSV/TSV）
   ↓
2. MediaController::preview()
   ├─ URL解析（parseUrl）
   ├─ com_media_assets 存在チェック
   ├─ hn_media_metadata 存在チェック
   └─ ステータス判定（New/Linked/Registered/Error）
   ↓
3. プレビュー表示（JavaScript）
   ├─ サムネイル表示
   ├─ ステータスバッジ
   └─ 除外ボタン
   ↓
4. MediaController::bulkSave()
   ├─ トランザクション開始
   ├─ com_media_assets に登録（findOrCreateAsset）
   ├─ hn_media_metadata に登録（findOrCreateMetadata）
   └─ コミット
```

### リリース・楽曲登録のフロー

```
1. リリース情報登録
   ↓ ReleaseController::save()
   ↓ hn_releases に INSERT
   ↓
2. 楽曲情報登録
   ↓ hn_songs に INSERT
   ↓
3. MV紐付け（オプション）
   ↓ media_meta_id を設定
   ↓ hn_media_metadata 経由で com_media_assets 参照
   ↓
4. 参加メンバー登録
   ↓ SongMemberModel::bulkInsertMembers()
   ↓ hn_song_members に一括 INSERT
```

---

## API仕様

### 動画一括登録API

#### **POST /hinata/api/preview_media.php**
**リクエスト**:
```json
{
  "raw_input": "URL\tタイトル\t公開日\tカテゴリ\n...",
  "default_category": "MV"
}
```

**レスポンス**:
```json
{
  "status": "success",
  "data": [
    {
      "url": "https://www.youtube.com/watch?v=xxxxx",
      "title": "楽曲タイトル",
      "category": "MV",
      "release_date": "2024-01-01",
      "status": "New",
      "message": "新規登録",
      "thumbnail": "https://img.youtube.com/vi/xxxxx/default.jpg",
      "video_key": "xxxxx"
    }
  ]
}
```

#### **POST /hinata/api/save_media_bulk.php**
**リクエスト**:
```json
{
  "items": [
    {
      "url": "https://www.youtube.com/watch?v=xxxxx",
      "title": "楽曲タイトル",
      "category": "MV",
      "release_date": "2024-01-01",
      "status": "New"
    }
  ]
}
```

**レスポンス**:
```json
{
  "status": "success",
  "saved": 5,
  "skipped": 2,
  "message": "5件を登録しました。2件をスキップしました。"
}
```

---

### 動画一覧API

#### **GET /hinata/api/load_more_media.php**
**パラメータ**:
- `offset` (int): 取得開始位置（デフォルト: 0）
- `limit` (int): 取得件数（デフォルト: 25、最大: 100）
- `category` (string): カテゴリフィルタ（空文字列の場合はすべて）
- `sort` (string): 並び順（`newest`, `oldest`, `title`）

**レスポンス**:
```json
{
  "status": "success",
  "data": [
    {
      "meta_id": 1,
      "category": "MV",
      "release_date": "2024-01-01",
      "asset_id": 1,
      "platform": "youtube",
      "media_key": "xxxxx",
      "title": "楽曲タイトル",
      "thumbnail_url": "https://img.youtube.com/vi/xxxxx/default.jpg",
      "created_at": "2024-01-01 12:00:00"
    }
  ],
  "has_more": true
}
```

---

### リリース管理API

#### **POST /hinata/api/save_release.php**
**リクエスト**:
```json
{
  "id": 1,
  "release_type": "single",
  "release_number": "1st",
  "title": "キュン",
  "title_kana": "きゅん",
  "release_date": "2019-03-27",
  "description": "デビューシングル",
  "songs": [
    {
      "title": "キュン",
      "track_type": "title",
      "track_number": 1,
      "members": [
        {
          "member_id": 5,
          "role": "center",
          "row_number": 1,
          "position": 0,
          "is_featured": 1
        }
      ]
    }
  ]
}
```

---

## 使用方法

### セットアップ

#### 1. データベース初期化
```sql
-- リリース管理テーブル作成
source private/migrations/db_migration_releases.sql;
```

#### 2. 既存データの更新（必要な場合）
```sql
-- 'member_kojin_pv' → 'SoloPV' に変更
UPDATE hn_media_metadata SET category = 'SoloPV' WHERE category = 'member_kojin_pv';
```

---

### 動画一括登録の使い方

1. **管理者ログイン**
2. **日向坂ポータル** → **動画一括登録**
3. **デフォルトカテゴリ**を選択（例: MV）
4. **一括入力データ**にTSV/CSVを貼り付け:
   ```
   https://www.youtube.com/watch?v=xxxxx	キュン	2019-03-27	MV
   https://www.youtube.com/watch?v=yyyyy	ドレミソラシド	2019-07-17	MV
   ```
5. **プレビュー**をクリック
6. **ステータス確認**（New/Linked/Registered/Error）
7. **一括登録実行**

---

### リリース・楽曲登録の使い方

1. **管理者ログイン**
2. **日向坂ポータル** → **リリース管理**
3. **新規リリース登録**
4. リリース情報を入力:
   - リリース種別: シングル
   - 番号: 1st
   - タイトル: キュン
   - 発売日: 2019-03-27
5. **保存**

---

### フォーメーション登録の使い方

```sql
-- 楽曲登録後、参加メンバーを登録
INSERT INTO hn_song_members (song_id, member_id, role, row_number, position, is_featured) VALUES
-- フロント（センター）
(1, 5, 'center', 1, 0, 1),

-- フロント（その他）
(1, 2, 'member', 1, -1, 0),
(1, 3, 'member', 1, 1, 0),

-- 2列目
(1, 4, 'member', 2, -1, 0),
(1, 6, 'member', 2, 0, 0),
(1, 7, 'member', 2, 1, 0);
```

---

## 今後の拡張予定

### Phase 2: 楽曲詳細管理UI
- [ ] リリース編集時に収録曲を同時管理
- [ ] フォーメーション入力UI（ビジュアルエディタ）
- [ ] センター・メンバー選択（ドラッグ&ドロップ）
- [ ] 列別配置の視覚的編集

### Phase 3: メディア一括登録との連携
- [ ] CSV入力時にリリースIDを指定
- [ ] 楽曲情報の自動紐付け
- [ ] プレビュー画面でリリース・楽曲情報を表示

### Phase 4: メンバー詳細ページの拡張
- [ ] 主役級参加楽曲セクションの追加
- [ ] センター経験回数表示
- [ ] フォーメーション履歴表示

### Phase 5: リリース一覧画面（ユーザー向け）
- [ ] タイムライン形式でリリース履歴表示
- [ ] MV埋め込み再生
- [ ] ジャケット画像表示
- [ ] 収録曲一覧とフォーメーション表示

### Phase 6: 高度な機能
- [ ] TikTok / Instagram対応
- [ ] CSVファイルアップロード対応
- [ ] フォーメーション比較機能
- [ ] メンバー参加楽曲の統計表示
- [ ] センターランキング

---

## 参考資料

### カテゴリ定義

#### **hn_media_metadata.category**
- `MV`: ミュージックビデオ
- `Live`: ライブ映像
- `Variety`: バラエティ
- `Event`: イベント動画
- `SoloPV`: 個人PV
- `Documentary`: ドキュメンタリー
- `Other`: その他

#### **hn_songs.track_type**
- `title`: 表題曲
- `coupling`: カップリング
- `album_only`: アルバム収録曲
- `bonus`: ボーナストラック
- `kisei`: 期別曲（1期生曲、2期生曲等）
- `unit`: ユニット曲
- `solo`: ソロ曲
- `other`: その他

#### **hn_song_members.role**
- `center`: センター
- `member`: 通常参加
- `under`: アンダー
- `other`: その他

#### **hn_releases.release_type**
- `single`: シングル
- `album`: アルバム
- `digital`: デジタルシングル
- `ep`: EP
- `best`: ベストアルバム

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2026-02-13 | 1.0 | 初版作成 |

---

## 作成者

**プロジェクト名**: マイポータルサイト  
**アプリ名**: 日向坂ポータル  
**ドキュメント作成**: 2026-02-13
