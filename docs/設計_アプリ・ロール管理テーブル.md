# アプリ管理・ロール管理 設計書

**作成日**: 2026-02-14  
**最終更新**: 2026-02-14（確定事項反映）  
**目的**: システムテーブル（アプリマスタ・ロールマスタ）の新設と、テーマカラー・ロール別UIの実現。

---

## 確定事項（方針）

| 項目 | 決定内容 |
|------|----------|
| アプリマスタの拡張 | **default_route / description / is_system** を実装する。**meta_json は実装しない**。 |
| データの持まわし | **案A**: ログイン時に一括取得しセッションに格納。 |
| sys_users のロール | **現状維持**: `role` を文字列（admin / user / hinata）のまま保持し、`sys_roles.role_key` と一致させる。role_id は持たない。 |
| キャッシュ無効化 | アプリ／ロールを管理画面で変更したあと、**全ユーザーのセッションを破棄する**。 |

---

## 1. アプリ管理テーブル（sys_apps）

### 1.1 概要

- 各アプリ（タスク管理、メモ、日向坂ポータル、管理画面など）を1件のレコードで管理。
- 日向坂ポータル配下の「子画面」（メンバー帳、イベント、ネタ帳、動画一覧など）も同じテーブルで表現し、`parent_id` で親子関係を持つ。
- テーマカラーを登録し、そのアプリ内ではその色をテーマカラーとして利用。
- **DBアクセス抑制**: ログイン時に一括取得しセッションに格納する（案A採用）。

### 1.2 テーブル定義

```sql
-- アプリ・画面マスタ（親子で1テーブル）
CREATE TABLE sys_apps (
    id              INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    app_key         VARCHAR(64) NOT NULL COMMENT '一意キー: task_manager, note, hinata, hinata_members 等',
    name            VARCHAR(100) NOT NULL COMMENT '表示名: タスク管理, メモ, 日向坂ポータル, メンバー帳 等',
    parent_id       INT UNSIGNED NULL DEFAULT NULL COMMENT '親アプリID。NULL=トップレベル',
    route_prefix    VARCHAR(128) NOT NULL DEFAULT '' COMMENT 'URLプレフィックス: /task_manager/, /hinata/, /note/',
    path            VARCHAR(255) NULL DEFAULT NULL COMMENT '子画面のときのパス: members.php, events.php 等',
    icon_class      VARCHAR(64) NULL DEFAULT NULL COMMENT 'FontAwesome: fa-list-check, fa-star, fa-house',
    theme_primary   VARCHAR(32) NULL DEFAULT NULL COMMENT 'テーマ色（Tailwind/hex）: sky-500, #0ea5e9',
    theme_light     VARCHAR(32) NULL DEFAULT NULL COMMENT '薄い色: sky-50, sky-100',
    default_route   VARCHAR(128) NULL DEFAULT NULL COMMENT 'そのアプリの入り口URL。ロールの初期画面に利用',
    description     VARCHAR(255) NULL DEFAULT NULL COMMENT '管理画面用の説明文',
    is_system       TINYINT(1) NOT NULL DEFAULT 0 COMMENT '1=システム固定。管理画面から削除不可',
    sort_order      SMALLINT UNSIGNED NOT NULL DEFAULT 0,
    is_visible      TINYINT(1) NOT NULL DEFAULT 1,
    admin_only      TINYINT(1) NOT NULL DEFAULT 0 COMMENT '1=管理者のみ表示',
    created_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_app_key (app_key),
    KEY idx_parent (parent_id),
    KEY idx_sort (sort_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='アプリ・画面マスタ';
```

- **トップレベル**: `parent_id = NULL`（ダッシュボード、タスク管理、メモ、日向坂ポータル、管理画面）。
- **子画面**: `parent_id = 日向坂ポータルの id`、`app_key = hinata_members` など、`path = members.php` でリンク先を表現。
- **テーマ**: `theme_primary` / `theme_light` をサイドバー・ヘッダー・ボタンに適用。Tailwind クラス（`sky-500`）または hex のどちらかに統一するか、両対応（先頭が `#` なら hex、否则 Tailwind）でも可。

### 1.3 アプリマスタの拡張項目（実装するもの）

| 項目 | 説明 | 実装 |
|------|------|------|
| **default_route** | そのアプリの「入り口」URL（例: 日向坂 → `/hinata/`）。ロールの「最初の画面」に使う。 | ✅ 実装 |
| **description** | 管理画面用の説明文。 | ✅ 実装 |
| **is_system** | 1 にすると管理画面から削除不可（タスク管理・メモ・管理画面など）。 | ✅ 実装 |
| **meta_json** | 将来の拡張用（キー・値の自由な設定）。 | ❌ 実装しない |

### 1.4 データの持まわし（キャッシュ方針）【案A採用】

- **採用方針**: **ログイン時に一括取得しセッションに格納**
  - ログイン処理で `sys_apps` を全件（または「表示対象のみ」）取得し、`$_SESSION['user']['apps_list']` などに保持する。
  - サイドバー・各画面はセッションから参照するだけにし、**通常リクエストでは sys_apps へのDBアクセスを行わない**。
  - 管理者がアプリを編集した場合は、**全ユーザーのセッションを破棄する**（本設計書「5. 補足」参照）。

---

## 2. ロール管理テーブル（sys_roles / sys_role_apps）

### 2.1 概要

- **admin** / **user** に加え、**hinata** のような「日向坂のみ」ロールを定義可能にする。
- ロールごとに「見せるアプリ」「サイドバー構成」「ロゴ文言」「初期表示URL」を変えられるようにする。

### 2.2 テーブル定義

```sql
-- ロールマスタ
CREATE TABLE sys_roles (
    id              INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    role_key        VARCHAR(32) NOT NULL COMMENT 'admin, user, hinata 等',
    name            VARCHAR(64) NOT NULL COMMENT '表示名: 管理者, 一般ユーザー, 日向坂のみ',
    description     VARCHAR(255) NULL DEFAULT NULL,
    default_route   VARCHAR(128) NOT NULL DEFAULT '/index.php' COMMENT 'ログイン後の初期URL',
    logo_text       VARCHAR(64) NULL DEFAULT NULL COMMENT 'NULL=MyPlatform。hinataなら「日向坂ポータル」等',
    sidebar_mode    ENUM('full','restricted') NOT NULL DEFAULT 'full' COMMENT 'restricted=当ロールで許可したアプリのみ',
    created_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_role_key (role_key)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ロールマスタ';

-- ロールごとに利用可能なアプリ（restricted のときのみ参照）
CREATE TABLE sys_role_apps (
    id              INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    role_id         INT UNSIGNED NOT NULL,
    app_id          INT UNSIGNED NOT NULL,
    sort_order      SMALLINT UNSIGNED NOT NULL DEFAULT 0,
    created_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_role_app (role_id, app_id),
    KEY idx_role (role_id),
    KEY idx_app (app_id),
    FOREIGN KEY (role_id) REFERENCES sys_roles(id) ON DELETE CASCADE,
    FOREIGN KEY (app_id)  REFERENCES sys_apps(id)  ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ロール別アプリ許可';
```

- **sys_users のロール表現【現状維持】**
  - `sys_users.role` は文字列のまま保持する（`'admin'` / `'user'` / `'hinata'` 等）。
  - `sys_roles.role_key` と一致させる。`role_id` は追加せず、正規化は行わない。

### 2.3 ロール別挙動のイメージ

| role_key | logo_text      | default_route | sidebar_mode | 備考 |
|----------|----------------|---------------|--------------|------|
| admin    | MyPlatform     | /index.php    | full         | 全アプリ＋管理画面 |
| user     | MyPlatform     | /index.php    | full         | 管理画面以外 |
| hinata   | 日向坂ポータル | /hinata/      | restricted   | sys_role_apps で「日向坂＋その子」だけ登録 |

- **sidebar_mode = restricted** のとき: サイドバーには `sys_role_apps` に登録された `app_id` のアプリのみ表示。ダッシュボード・タスク・メモは出さない（または「日向坂ポータル」1本＋その子のみ）。
- **logo_text**: サイドバー左上の文言。NULL なら従来どおり「MyPlatform」。

### 2.4 ログイン時のセッション構造案

現在の `$_SESSION['user']` に、アプリ・ロール情報を追加するイメージです。

```php
$_SESSION['user'] = [
    'id'       => $user['id'],
    'id_name'  => $user['id_name'],
    'role'     => $user['role'],           // 文字列のまま。sys_roles.role_key と一致
    // 以下、ログイン時に sys_apps / sys_roles / sys_role_apps から組み立て
    'apps'     => [                        // 表示するアプリの配列（親子含む）
        ['id' => 1, 'app_key' => 'dashboard', 'name' => 'ダッシュボード', ...],
        ['id' => 2, 'app_key' => 'hinata', 'name' => '日向坂ポータル', 'children' => [...]],
    ],
    'theme'    => [ ... ],                  // 現在表示中アプリのテーマ色（都度解決でも可）
    'logo_text'      => $role['logo_text'] ?? 'MyPlatform',
    'default_route'  => $role['default_route'] ?? '/index.php',
    'sidebar_mode'   => $role['sidebar_mode'] ?? 'full',
];
```

- サイドバーは `$_SESSION['user']['apps']` をループして描画。
- 現在のURIから「どの app_id か」を判定し、そのアプリの `theme_primary` をヘッダーやアクティブ色に使う。

---

## 3. 管理画面での管理機能

### 3.1 アプリ管理（管理画面に追加）

- **一覧**: sys_apps をツリー表示（親 → 子）。
- **追加・編集**: app_key, name, parent_id, route_prefix, path, icon_class, theme_primary / theme_light, **default_route, description, is_system**, sort_order, is_visible, admin_only。
- **削除**: 子がいる親は削除不可、または子ごと削除の確認。**is_system=1 のレコードは削除不可**。
- **並び順**: sort_order の一括変更（ドラッグ＆ドロップ or 数値入力）。

### 3.2 ロール管理（管理画面に追加）

- **一覧**: sys_roles の一覧。
- **追加・編集**: role_key, name, description, default_route, logo_text, sidebar_mode。
- **アプリ割り当て**（sidebar_mode = restricted のとき）: チェックボックスで「このロールで表示するアプリ」を sys_role_apps に保存。

### 3.3 ユーザー管理との連携

- 既存の「ユーザー管理」で、ユーザーに付与するロールを **sys_roles から選択**するように変更（プルダウンが sys_roles の name / role_key を参照）。

---

## 4. 実装の進め方（フェーズ案）

| フェーズ | 内容 |
|----------|------|
| **1** | sys_apps / sys_roles / sys_role_apps のマイグレーション作成と初期データ投入（admin, user と既存アプリの登録）。 |
| **2** | ログイン時に sys_apps と sys_roles（＋必要なら sys_role_apps）を取得し、セッションに `apps` / `logo_text` / `default_route` / `sidebar_mode` を格納。既存のハードコードされたサイドバーは「セッションの apps が空なら従来どおり」のフォールバック付きで、セッション由来のメニューに切り替え。 |
| **3** | サイドバー・ヘッダーで「現在アプリ」に応じた theme_primary を適用。 |
| **4** | 管理画面に「アプリ管理」「ロール管理」のCRUD画面を追加。 |
| **5** | hinata ロールを追加し、sys_role_apps で日向坂のみ許可。sidebar_mode=restricted でロゴ「日向坂ポータル」・default_route=/hinata/ を検証。 |

---

## 5. 補足（セキュリティ・運用）

- **route_prefix / path**: サイドバー表示の「どのアプリに属するか」の判定用。実際のアクセス制御は従来どおり各コントローラの `requireLogin()` / `requireAdmin()` で行い、**表示の出し分け**と**初期リダイレクト**に sys_apps / sys_roles を使う形にすると安全です。
- **admin_only**: サイドバーで「管理者のみ表示」するアプリに付与。既存の `role === 'admin'` と組み合わせて利用。
- **キャッシュ無効化【確定】**: アプリ／ロールを管理画面で変更したあと、**全ユーザーのセッションを破棄する**。管理画面のアプリ保存・ロール保存処理のなかで、`sys_sessions` を truncate するか、該当するセッションを削除する処理を実行する。これにより、全ユーザーは次回アクセス時に再ログインとなり、最新の apps / ロール設定がセッションに反映される。

この設計書をベースに、マイグレーションとログイン処理の変更から実装を進める。
